# 🎯 投影数学修复总结

## 已修复的问题

### 1. ✅ 过滤 3D 视口
**问题：** 代码在所有视口（包括 3D 视图）上绘制投影
**修复：**
```typescript
// Skip non-MPR viewports
if (viewport.type === 'stack') {
  return; // Skip stack viewports
}

// Check if this is a 3D viewport
const viewportClassName = viewport.constructor.name;
if (viewportClassName === 'VolumeViewport3D') {
  return; // Skip 3D viewports - projection only for 2D MPR
}
```

**结果：** 投影只在 MPR 平面（Axial, Sagittal, Coronal）上显示

### 2. ✅ 正确的平面-线段相交数学
**问题：** 简单投影 3D 端点，不考虑工具是否真的穿过平面
**修复：** 实现完整的线-平面相交算法

#### 平面方程
```
n · (P - P0) = 0
其中：
n = viewPlaneNormal (平面法向量)
P0 = focalPoint (平面上的点)
P = 3D 空间中的点
```

#### 工具线段方程
```
P = origin + t * direction
其中：
origin = 工具原点
direction = 工具 Z 轴方向（归一化）
t ∈ [0, toolLength]
```

#### 相交参数
```
t = n · (P0 - origin) / (n · direction)
```

#### 三种情况

**情况 A：工具穿过平面** (`0 ≤ t ≤ toolLength`)
- 计算交点：`intersection = origin + t * direction`
- 绘制**实线**（绿色）从原点到交点
- 添加**红色十字**标记交点
```
       ● intersection (红色十字)
      /
     /  实线(绿色)
    /
───●─────── MPR 平面
  origin
```

**情况 B：工具平行于平面** (`|n · direction| < 0.001`)
- 检查原点距离平面的距离
- 如果 < 1mm：投影整条工具线，绘制**虚线**（橙色）
- 如果 > 1mm：不显示

```
origin ────────● tip
       \      /
        \    /  投影(虚线,橙色)
─────────●────●───── MPR 平面
    投影原点  投影端点
```

**情况 C：交点在工具范围外** (`t < 0` 或 `t > toolLength`)
- 检查原点或端点是否接近平面（< 5mm）
- 如果接近：显示投影（虚线）
- 如果远离：不显示

```
       ● tip
      /
     /  工具
    /
   ● origin
   
───────────── MPR 平面
   (工具不穿过，距离 > 5mm，不显示)
```

### 3. ✅ 视觉区分

**实线（绿色）** = 工具实际穿过平面
- 粗线（3px）
- 绿色 `#00ff00`
- 不透明度 0.9
- 绿色箭头

**虚线（橙色）** = 工具投影到平面
- 细线（2px）
- 橙色 `#ffaa00`
- 虚线样式 `8,4`
- 不透明度 0.7
- 橙色箭头

**标记：**
- 蓝色圆点 = 工具原点
- 红色十字 = 平面交点（仅实线模式）

## 数学验证

### 测试场景 1：工具垂直于 Axial 平面
```
工具方向: Z-axis = [0, 0, 1] (垂直向上)
Axial 平面法向量: n = [0, 0, ±1]

n · direction = ±1
denominator ≈ 1 (不平行)

结果：显示交点（实线）✅
```

### 测试场景 2：工具平行于 Axial 平面
```
工具方向: Z-axis = [1, 0, 0] (水平)
Axial 平面法向量: n = [0, 0, 1]

n · direction = 0
denominator < 0.001 (平行)

结果：
- 如果原点在平面上 → 显示投影（虚线）✅
- 如果原点远离平面 → 不显示 ✅
```

### 测试场景 3：工具倾斜 45°
```
工具方向: Z-axis = [0.707, 0, 0.707]
Axial 平面法向量: n = [0, 0, 1]

n · direction = 0.707
denominator ≠ 0

计算 t，检查范围：
- 0 ≤ t ≤ 100mm → 显示交点（实线）✅
- t < 0 或 t > 100mm → 检查距离，可能显示投影 ✅
```

## 实现的改进

1. **数学正确性** ✅
   - 使用标准的线-平面相交公式
   - 处理所有边界情况（平行、远离、穿过）
   - 正确的向量运算（归一化、点积）

2. **视觉清晰性** ✅
   - 实线 vs 虚线区分实际 vs 投影
   - 颜色编码（绿色=交点，橙色=投影）
   - 红色十字标记交点位置

3. **性能优化** ✅
   - 早期退出（平行远离情况）
   - 距离阈值避免不必要的渲染
   - 复用 SVG 元素

4. **鲁棒性** ✅
   - 处理分母接近 0 的情况（平行）
   - 数值阈值（1mm, 5mm）避免浮点误差
   - try-catch 错误处理

## 与之前实现的对比

### 之前（简单投影）
```typescript
// ❌ 问题：直接投影 3D 点，不考虑平面关系
const originCanvas = viewport.worldToCanvas(origin);
const tipCanvas = viewport.worldToCanvas(tip);
drawLine(originCanvas, tipCanvas);
```

**问题：**
- 工具平行于平面时仍显示为线（不正确）
- 工具远离平面时仍显示（误导）
- 无法区分"穿过"vs"投影"
- 在 3D 视口上也绘制（无意义）

### 现在（正确数学）
```typescript
// ✅ 正确：计算线-平面相交
const t = numerator / denominator;

if (parallel) {
  // 显示投影（虚线）或不显示
} else if (0 <= t <= toolLength) {
  // 显示交点（实线）+ 红色十字
} else if (nearPlane) {
  // 显示投影（虚线）
} else {
  // 不显示
}
```

**优势：**
- 数学正确
- 视觉清晰
- 性能良好
- 处理所有情况

## 用户体验改进

### 场景 A：术中导航（工具穿过平面）
- ✅ 看到**绿色实线** → 工具确实穿过此平面
- ✅ 看到**红色十字** → 知道工具与平面的交点位置
- ✅ 可以精确判断工具位置

### 场景 B：术前规划（工具在平面附近）
- ✅ 看到**橙色虚线** → 知道这是投影，不是实际位置
- ✅ 可以评估工具路径
- ✅ 不会误认为工具已到达

### 场景 C：多平面视图
- ✅ Axial：可能显示实线（工具穿过）
- ✅ Sagittal：可能显示虚线（投影）
- ✅ Coronal：可能不显示（太远）
- ✅ 清晰了解工具与每个平面的关系

## 下一步建议

1. **添加深度指示** （未来）
   - 显示工具距平面的距离
   - 例如："+5mm" 或 "-5mm"

2. **颜色渐变** （未来）
   - 根据距离改变颜色
   - 近=绿色，远=灰色

3. **交互式调整** （未来）
   - 点击投影线选择工具
   - 显示详细信息面板

4. **多工具支持** （未来）
   - 同时显示多个工具的投影
   - 不同颜色区分不同工具

